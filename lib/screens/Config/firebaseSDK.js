var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:true});exports.default=void 0;var _regenerator=_interopRequireDefault(require("@babel/runtime/regenerator"));var _classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));var _createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass"));var _firebase=_interopRequireDefault(require("firebase"));var FirebaseSDK=function(){function FirebaseSDK(){var _this=this;(0,_classCallCheck2.default)(this,FirebaseSDK);this.init=function(){if(!_firebase.default.apps.length){_firebase.default.initializeApp({apiKey:"AIzaSyA8Dp8yInWfJV_qUQdgZfknhZXDeeENFzg",authDomain:"naxechat.firebaseapp.com",databaseURL:"https://naxechat-default-rtdb.firebaseio.com",projectId:"naxechat",storageBucket:"naxechat.appspot.com",messagingSenderId:"23143048525",appId:"1:23143048525:web:3b9d70f2db9de05796c304",measurementId:"G-TTQSG6KSY3"});}};this.observeAuth=function(){return _firebase.default.auth().onAuthStateChanged(_this.onAuthStateChanged);};this.onAuthStateChanged=function(user){if(!user){try{_firebase.default.auth().signInAnonymously();}catch(_ref){var message=_ref.message;alert(message);}}};this.login=function _callee(user,success_callback,failed_callback){return _regenerator.default.async(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:_context.next=2;return _regenerator.default.awrap(_firebase.default.auth().signInWithEmailAndPassword(user.email,user.password).then(success_callback,failed_callback));case 2:case"end":return _context.stop();}}},null,null,null,Promise);};this.parse=function(snapshot){var _snapshot$val=snapshot.val(),numberStamp=_snapshot$val.timestamp,text=_snapshot$val.text,user=_snapshot$val.user;var _id=snapshot.key;var timestamp=new Date(numberStamp);var message={_id:_id,timestamp:timestamp,text:text,user:user};return message;};this.on=function(callback){return _this.ref.limitToLast(20).on("child_added",function(snapshot){return callback(_this.parse(snapshot));});};this.send=function(messages){for(var i=0;i<messages.length;i++){var _messages$i=messages[i],text=_messages$i.text,user=_messages$i.user;var message={text:text,user:user,timestamp:_this.timestamp};_this.append(message);}};this.append=function(message){return _this.ref.push(message);};this.createAccount=function _callee2(user){return _regenerator.default.async(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:_firebase.default.auth().createUserWithEmailAndPassword(user.email,user.password).then(function(){console.log("created user successfully. User email:"+user.email+" name:"+user.name);var userf=_firebase.default.auth().currentUser;userf.updateProfile({displayName:user.name}).then(function(){console.log("Updated displayName successfully. name:"+user.name);alert("User "+user.name+" was created successfully. Please login.");},function(error){console.warn("Error update displayName.");});},function(error){console.error("got error:"+typeof error+" string:"+error.message);alert("Create account failed. Error: "+error.message);});case 1:case"end":return _context2.stop();}}},null,null,null,Promise);};this.uploadImage=function _callee3(uri){var response,blob,ref,task;return _regenerator.default.async(function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:console.log("got image to upload. uri:"+uri);_context3.prev=1;_context3.next=4;return _regenerator.default.awrap(fetch(uri));case 4:response=_context3.sent;_context3.next=7;return _regenerator.default.awrap(response.blob());case 7:blob=_context3.sent;ref=_firebase.default.storage().ref("avatar").child(uuid.v4());task=ref.put(blob);return _context3.abrupt("return",new Promise(function(resolve,reject){task.on("state_changed",function(){},resolve(task.snapshot.downloadURL));}));case 13:_context3.prev=13;_context3.t0=_context3["catch"](1);console.log("uploadImage try/catch error: "+_context3.t0.message);case 16:case"end":return _context3.stop();}}},null,null,[[1,13]],Promise);};this.updateAvatar=function(url){var userf=_firebase.default.auth().currentUser;if(userf!=null){userf.updateProfile({avatar:url}).then(function(){console.log("Updated avatar successfully. url:"+url);alert("Avatar image is saved successfully.");},function(error){console.warn("Error update avatar.");alert("Error update avatar. Error:"+error.message);});}else{console.log("can't update avatar, user is not login.");alert("Unable to update avatar. You must login first.");}};this.init();}(0,_createClass2.default)(FirebaseSDK,[{key:"off",value:function off(){this.ref.off();}},{key:"uid",get:function get(){return(_firebase.default.auth().currentUser||{}).uid;}},{key:"ref",get:function get(){return _firebase.default.database().ref("messages");}},{key:"timestamp",get:function get(){return _firebase.default.database.ServerValue.TIMESTAMP;}}]);return FirebaseSDK;}();var firebaseSDK=new FirebaseSDK();var _default=firebaseSDK;exports.default=_default;